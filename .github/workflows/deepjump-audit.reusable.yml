name: DeepJump Audit (reusable)

on:
  workflow_call:
    inputs:
      python-version:
        required: false
        type: string
        default: "3.11"
    secrets:
      ENTA_HMAC_SECRET:
        required: true

jobs:
  deepjump-audit:
    runs-on: ubuntu-latest
    env:
      ENTA_HMAC_SECRET: ${{ secrets.ENTA_HMAC_SECRET }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install Dependencies
        run: |
          pip install pyyaml pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Mask HMAC secret
        shell: bash
        run: |
          if [ -n "${ENTA_HMAC_SECRET:-}" ]; then
            echo "::add-mask::$ENTA_HMAC_SECRET"
          fi

      - name: "Phase 1: Verify Pointers"
        run: python3 tools/verify_pointers.py --strict

      - name: "Phase 1b: Receipt Lint (no duplicate keys)"
        run: python3 tools/receipt_lint.py --strict ark/p4/receipts

      - name: "Phase 1: Claim Lint"
        run: python3 tools/claim_lint.py --scope index,spec,receipts,tools

      - name: "Phase 1: Run Tests"
        run: pytest tests/ -v --tb=short

      - name: "Phase 2: Emit & Verify Status"
        run: make status-verify STATUS=PASS H=0.85 DMI=4.8 PHI=0.75

      - name: "Phase 3: Generate Snapshot Manifest"
        run: make snapshot SNAPSHOT_INPUTS='"seeds/*.yaml" "audit/*.yaml" "index/*.yaml"'

      - name: "Legacy: Verify JSON Receipts"
        run: make verify-json

      - name: Upload Audit Artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: deepjump-audit-trail
          path: |
            out/status/deepjump_status.json
            out/badges/deepjump.svg
            out/verify.json
            out/snapshot_manifest.json
          if-no-files-found: warn
