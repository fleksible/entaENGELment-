name: Metatron Guard

on:
  pull_request:
    types: [opened, edited, synchronize]
  push:
    branches-ignore:
      - main

jobs:
  metatron-pr-check:
    name: Check PR for FOKUS marker
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: "3.11"

      - name: Check PR body for FOKUS / FOKUS-SWITCH
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Checking PR body for Metatron-Guard compliance..."
          echo ""

          # Handle empty PR body
          if [ -z "$PR_BODY" ]; then
            echo "::warning::PR body is empty - consider adding FOKUS: marker"
            echo ""
            echo "Recommended: Add a PR description with:"
            echo "  FOKUS: <your task focus>"
            echo ""
            echo "If you switched focus during this PR, also add:"
            echo "  FOKUS-SWITCH: <old focus> -> <new focus>"
            echo "  <question ending with ?>"
            exit 0
          fi

          # Run the metatron check
          # Exit 1 = missing FOKUS (non-blocking warning)
          # Other non-zero = script error (should fail CI)
          set +e
          echo "$PR_BODY" | python tools/metatron_check.py --verbose
          EXIT_CODE=$?
          set -e

          if [ "$EXIT_CODE" -eq 0 ]; then
            exit 0
          elif [ "$EXIT_CODE" -eq 1 ]; then
            echo "::warning::PR body lacks FOKUS: marker - see docs/guards/metatron_rule.md"
            exit 0
          else
            echo "::error::metatron_check.py failed unexpectedly (exit code: $EXIT_CODE)"
            exit 1
          fi

      - name: Post failure instructions
        if: failure()
        run: |
          echo ""
          echo "================================================"
          echo "  Metatron-Guard Check Failed (Script Error)"
          echo "================================================"
          echo ""
          echo "The metatron_check.py script encountered an unexpected error."
          echo "This is NOT about a missing FOKUS marker - check the error above."
          echo ""
          echo "Possible causes:"
          echo "  - Script file missing or not executable"
          echo "  - Python syntax/import error"
          echo "  - Runtime exception"
          echo ""
          echo "See: tools/metatron_check.py for the script source"
          echo "================================================"

  metatron-commit-check:
    name: Check commits for FOKUS marker
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0

      - name: Check commit message for FOKUS marker
        run: |
          echo "Checking commit for Metatron-Guard compliance..."
          echo ""

          COMMIT_MSG=$(git log -1 --format=%s)
          COMMIT_BODY=$(git log -1 --format=%B)

          echo "Commit: $COMMIT_MSG"
          echo ""

          # Skip merge commits
          if echo "$COMMIT_MSG" | grep -qE "^Merge "; then
            echo "✓ Merge commit - FOKUS check skipped"
            exit 0
          fi

          # Skip squash! commits (git rebase --autosquash)
          if echo "$COMMIT_MSG" | grep -qE "^squash! "; then
            echo "✓ Squash commit - FOKUS check skipped"
            exit 0
          fi

          # Skip fixup! commits (git rebase --autosquash)
          if echo "$COMMIT_MSG" | grep -qE "^fixup! "; then
            echo "✓ Fixup commit - FOKUS check skipped"
            exit 0
          fi

          # Check for FOKUS marker in commit body
          if echo "$COMMIT_BODY" | grep -q "FOKUS:"; then
            echo "✓ FOKUS marker found"
            echo ""
            echo "$COMMIT_BODY" | grep "FOKUS:"
            exit 0
          fi

          # FOKUS not found - warn but don't fail (soft enforcement)
          echo "⚠ Warning: Commit lacks FOKUS marker"
          echo ""
          echo "Recommended format:"
          echo "  FOKUS: <brief task description>"
          echo ""
          echo "This is currently a soft warning. Future enforcement may require FOKUS."
          exit 0
