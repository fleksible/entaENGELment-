name: Metatron Guard

on:
  pull_request:
    types: [opened, edited, synchronize]
  push:
    branches-ignore:
      - main

jobs:
  metatron-pr-check:
    name: Check PR for FOKUS marker
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check PR body for FOKUS / FOKUS-SWITCH
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Checking PR body for Metatron-Guard compliance..."
          echo ""

          # Handle empty PR body
          if [ -z "$PR_BODY" ]; then
            echo "::warning::PR body is empty - consider adding FOKUS: marker"
            echo ""
            echo "Recommended: Add a PR description with:"
            echo "  FOKUS: <your task focus>"
            echo ""
            echo "If you switched focus during this PR, also add:"
            echo "  FOKUS-SWITCH: <old focus> -> <new focus>"
            echo "  <question ending with ?>"
            exit 0
          fi

          # Run the metatron check (non-blocking)
          echo "$PR_BODY" | python tools/metatron_check.py --verbose || {
            echo "::warning::PR body lacks FOKUS: marker - see docs/guards/metatron_rule.md"
            exit 0
          }

      - name: Post failure instructions
        if: failure()
        run: |
          echo ""
          echo "================================================"
          echo "  Metatron-Guard Check Failed"
          echo "================================================"
          echo ""
          echo "Your PR body must include:"
          echo ""
          echo "  FOKUS: <brief description of your task focus>"
          echo ""
          echo "Example:"
          echo "  FOKUS: Add authentication to API"
          echo ""
          echo "If you changed focus during this work, also add:"
          echo ""
          echo "  FOKUS-SWITCH: <old focus> -> <new focus>"
          echo "  Why did you switch? <question with ?>"
          echo ""
          echo "Example:"
          echo "  FOKUS-SWITCH: Add auth -> Fix security bug"
          echo "  Should we prioritize the security fix?"
          echo ""
          echo "See: docs/guards/metatron_rule.md for details"
          echo "================================================"

  metatron-commit-check:
    name: Check commits for FOKUS marker
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit message for FOKUS marker
        run: |
          echo "Checking commit for Metatron-Guard compliance..."
          echo ""

          COMMIT_MSG=$(git log -1 --format=%s)
          COMMIT_BODY=$(git log -1 --format=%B)

          echo "Commit: $COMMIT_MSG"
          echo ""

          # Skip merge commits
          if echo "$COMMIT_MSG" | grep -qE "^Merge "; then
            echo "✓ Merge commit - FOKUS check skipped"
            exit 0
          fi

          # Skip squash! commits (git rebase --autosquash)
          if echo "$COMMIT_MSG" | grep -qE "^squash! "; then
            echo "✓ Squash commit - FOKUS check skipped"
            exit 0
          fi

          # Skip fixup! commits (git rebase --autosquash)
          if echo "$COMMIT_MSG" | grep -qE "^fixup! "; then
            echo "✓ Fixup commit - FOKUS check skipped"
            exit 0
          fi

          # Check for FOKUS marker in commit body
          if echo "$COMMIT_BODY" | grep -q "FOKUS:"; then
            echo "✓ FOKUS marker found"
            echo ""
            echo "$COMMIT_BODY" | grep "FOKUS:"
            exit 0
          fi

          # FOKUS not found - warn but don't fail (soft enforcement)
          echo "⚠ Warning: Commit lacks FOKUS marker"
          echo ""
          echo "Recommended format:"
          echo "  FOKUS: <brief task description>"
          echo ""
          echo "This is currently a soft warning. Future enforcement may require FOKUS."
          exit 0
