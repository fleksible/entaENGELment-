name: Metatron Guard

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  metatron-check:
    name: Check PR for FOKUS marker
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check PR body for FOKUS / FOKUS-SWITCH
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Checking PR body for Metatron-Guard compliance..."
          echo ""

          # Handle empty PR body
          if [ -z "$PR_BODY" ]; then
            echo "Error: PR body is empty"
            echo "METATRON-GUARD: FAIL"
            echo ""
            echo "Please add a PR description with:"
            echo "  FOKUS: <your task focus>"
            echo ""
            echo "If you switched focus during this PR, also add:"
            echo "  FOKUS-SWITCH: <old focus> -> <new focus>"
            echo "  <question ending with ?>"
            exit 1
          fi

          # Run the metatron check
          echo "$PR_BODY" | python tools/metatron_check.py --verbose

      - name: Post failure instructions
        if: failure()
        run: |
          echo ""
          echo "================================================"
          echo "  Metatron-Guard Check Failed"
          echo "================================================"
          echo ""
          echo "Your PR body must include:"
          echo ""
          echo "  FOKUS: <brief description of your task focus>"
          echo ""
          echo "Example:"
          echo "  FOKUS: Add authentication to API"
          echo ""
          echo "If you changed focus during this work, also add:"
          echo ""
          echo "  FOKUS-SWITCH: <old focus> -> <new focus>"
          echo "  Why did you switch? <question with ?>"
          echo ""
          echo "Example:"
          echo "  FOKUS-SWITCH: Add auth -> Fix security bug"
          echo "  Should we prioritize the security fix?"
          echo ""
          echo "See: docs/guards/metatron_rule.md for details"
          echo "================================================"
