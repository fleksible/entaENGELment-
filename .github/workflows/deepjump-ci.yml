name: DeepJump CI

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  deepjump-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Dependencies
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Set CI_SECRET (repo secret or ephemeral)
        env:
          REPO_SECRET: ${{ secrets.CI_SECRET }}
        run: |
          if [ -n "$REPO_SECRET" ]; then
            echo "CI_SECRET=$REPO_SECRET" >> "$GITHUB_ENV"
          else
            echo "CI_SECRET=$(openssl rand -hex 32)" >> "$GITHUB_ENV"
          fi
      - name: Verify Logic (P9 Check)
        run: make verify-json
      - name: Emit & Verify Status Integrity
        run: make status-verify STATUS=PASS H=0.85 DMI=4.8 PHI=0.75
      - name: Generate Snapshot Manifest
        run: make snapshot SNAPSHOT_INPUTS='"seeds/*.yaml" "audit/*.yaml"'
      - name: Upload Audit Artifacts
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: deepjump-audit-trail
          path: |
            out/status/deepjump_status.json
            out/badges/deepjump.svg
            out/verify.json
            out/snapshot_manifest.json
