name: DeepJump CI

# DeepJump Protocol v1.2 CI Pipeline
# Verify → Status (HMAC) → Snapshot (strict) → Upload

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  deepjump-audit:
    runs-on: ubuntu-latest
    env:
      ENTA_HMAC_SECRET: ${{ secrets.ENTA_HMAC_SECRET }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          pip install pyyaml pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Set HMAC Secret (fallback to ephemeral)
        run: |
          if [ -z "$ENTA_HMAC_SECRET" ]; then
            echo "ENTA_HMAC_SECRET=$(openssl rand -hex 32)" >> "$GITHUB_ENV"
            echo "::warning::No ENTA_HMAC_SECRET set. Using ephemeral secret."
          fi

      - name: Mask HMAC secret
        shell: bash
        run: |
          if [ -n "${ENTA_HMAC_SECRET:-}" ]; then
            echo "::add-mask::$ENTA_HMAC_SECRET"
          fi

      # Phase 1: VERIFY
      - name: "Phase 1: Verify Pointers"
        run: python3 tools/verify_pointers.py --strict

      - name: "Phase 1: Claim Lint"
        run: python3 tools/claim_lint.py --scope index,spec,receipts,tools
        continue-on-error: true  # Warning only, not blocking

      - name: "Phase 1: Run Tests"
        run: pytest tests/ -v --tb=short || echo "::warning::Some tests failed"

      # Phase 2: STATUS
      - name: "Phase 2: Emit & Verify Status"
        run: make status-verify STATUS=PASS H=0.85 DMI=4.8 PHI=0.75

      # Phase 3: SNAPSHOT
      - name: "Phase 3: Generate Snapshot Manifest"
        run: make snapshot SNAPSHOT_INPUTS='"seeds/*.yaml" "audit/*.yaml" "index/*.yaml"'

      # Legacy verification
      - name: "Legacy: Verify JSON Receipts"
        run: make verify-json || echo "::warning::Legacy verify-json failed"
        continue-on-error: true

      # Upload artifacts
      - name: Upload Audit Artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: deepjump-audit-trail
          path: |
            out/status/deepjump_status.json
            out/badges/deepjump.svg
            out/verify.json
            out/snapshot_manifest.json
          if-no-files-found: warn
