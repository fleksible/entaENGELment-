name: Tests

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

permissions:
  contents: read

jobs:
  test-javascript:
    name: JavaScript Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run JavaScript tests
        run: npm run test:js

      - name: Run JavaScript tests with coverage
        run: npm run test:js:coverage

      - name: Upload JS coverage report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: js-coverage-report
          path: coverage/js/
          retention-days: 14

  test-python:
    name: Python Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: Fractalsense/requirements-dev.txt

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r Fractalsense/requirements-dev.txt

      - name: Run Python tests
        run: |
          cd Fractalsense
          python -m pytest --cov --cov-report=xml --cov-report=html

      - name: Upload Python coverage report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: python-coverage-report-${{ matrix.python-version }}
          path: Fractalsense/htmlcov/
          retention-days: 14

  all-tests-pass:
    name: All Tests Pass
    needs: [test-javascript, test-python]
    runs-on: ubuntu-latest
    steps:
      - name: All tests passed
        run: echo "All JavaScript and Python tests passed successfully!"
