name: CI Pipeline - entaENGELment Framework

on:
  push:
    branches: ["main", "claude/**"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  # Stage 1: Verify - Linting and Type Checking
  verify:
    name: Verify (Lint & Type Check)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          fetch-depth: 2

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Lint with ruff
        run: |
          ruff check src/ tools/ tests/

      - name: Format check with black
        run: |
          black --check src/ tools/ tests/

      - name: Type check with mypy
        run: |
          mypy src/ tools/

  # Stage 2: Build - Run Tests with Coverage
  build:
    name: Build (Test & Coverage)
    needs: verify
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          fetch-depth: 2

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -e .

      - name: Run unit tests
        run: |
          pytest tests/unit/ -v --tb=short

      - name: Run integration tests
        run: |
          pytest tests/integration/ -v --tb=short

      - name: Run ethics tests (fail-safe)
        run: |
          pytest tests/ethics/ -v --tb=short

      - name: Run all tests with coverage
        run: |
          pytest --cov --cov-report=xml --cov-report=term

      - name: Upload coverage reports
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238  # v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          flags: unittests
          name: codecov-${{ matrix.python-version }}
        continue-on-error: true

      - name: Check coverage threshold
        run: |
          coverage report --fail-under=50

  # Stage 3: Security - Security Scan
  security:
    name: Security Scan
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit safety

      - name: Run bandit security linter
        run: |
          bandit -c .bandit.yaml -r src/ tools/ -f json -o bandit-report.json

      - name: Check dependencies for vulnerabilities
        run: |
          pip freeze | safety check --stdin --json

  # Stage 4: Gate Policy Validation
  gate-policy:
    name: Gate Policy Validation
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Validate gate opens with valid context
        run: |
          python tools/mzm/gate_toggle.py 0.9 true true 1.0 true | grep "GateOpen=true"

      - name: Validate gate closes with invalid phi
        run: |
          python tools/mzm/gate_toggle.py 0.5 true true 1.0 true | grep "GateOpen=false"

      - name: Validate gate closes without consent
        run: |
          python tools/mzm/gate_toggle.py 0.9 false true 1.0 true | grep "GateOpen=false"

  # Success notification
  all-checks-passed:
    name: All Checks Passed
    needs: [verify, build, security, gate-policy]
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Success
        run: |
          echo "All CI checks passed successfully!"
          echo "- Verify: Linting and type checking"
          echo "- Build: Tests and coverage"
          echo "- Security: Security scan"
          echo "- Gate Policy: Validation"
